# テスト関連の課題と解決策

## Issue #12: テスト実行時の問題

### 概要
タスク管理システムのテスト実行において、環境依存の問題やライブラリの互換性問題により、一部のテストが失敗する状況が発生しました。これらの問題は主に以下の3つに分類されます：

1. TypeScript型の不一致
2. 環境変数の反映問題
3. Node.jsバージョンとライブラリの互換性問題

### 対応済みの問題

#### TypeScript型の不一致
`delete-task.ts`において、`TaskInfo`型に存在しない`description`プロパティを参照していた問題を修正しました。
```typescript
// 修正前
console.log(`説明: ${task.description || 'なし'}`);

// 修正後（プロパティへの参照を削除）
console.log(`優先度: ${task.priority}`);
```

#### 環境変数対応
タスクディレクトリのパス設定を環境変数から取得できるよう`task-utils.ts`を修正しました。
```typescript
// 修正前
const TASK_DIR = path.join(process.cwd(), 'tasks');

// 修正後
const TASK_DIR = process.env.TASK_DIR || path.join(process.cwd(), 'tasks');
```

### 解決が必要な問題

#### 環境変数の反映問題
テスト環境では`process.env.TASK_DIR`を設定しても、実行時に正しく反映されない場合があります。これはNode.jsの子プロセス実行時の環境変数継承に関する問題です。

#### ライブラリの互換性問題
現在のNode.js v16.10.0では、Honoモジュールの最新版と互換性がなく、MCPサーバーのテストが失敗します。

```
TypeError: Class extends value undefined is not a constructor or null
```

### 解決策

#### 短期的な対策
1. 問題のあるテストをスキップ：`it.skip()`や`describe.skip()`を使用
2. 代替のテストを追加：モックやスタブを使用し、直接的なファイル操作を避ける
3. TODOコメントで情報を残す：将来の修正のために問題の詳細を記録

#### 長期的な対策
1. Node.jsのバージョンアップ：v18以上に更新し、ライブラリの互換性問題を解決
2. テスト環境の分離：テスト固有のディレクトリ構造や環境変数設定の仕組みを改善
3. モックの活用：ファイルシステムや日付などの外部依存を適切にモック化

## TDDにおけるテストと実装のバランス

### テストファーストの原則と現実の折り合い
TDD（テスト駆動開発）では「先にテストを書き、それを満たす実装を行う」というアプローチが基本ですが、環境依存や外部ライブラリの問題により、一時的にテストが失敗することは避けられない場合があります。

### 対処方法

#### 1. テストの一時的スキップ
```typescript
// 問題のあるテストを一時的にスキップし、情報を残す
it.skip('環境依存のためスキップされたテスト', () => {
  // TODO: Node.jsバージョンアップ後に再有効化
  // ...テストコード...
});
```

#### 2. 代替テストの作成
```typescript
// 環境依存を避けた代替テスト
it('機能の核心部分のみをテスト', () => {
  // 直接ファイルシステムを操作せず、関数の核心的な部分のみをテスト
  const result = someFunction(mockInput);
  expect(result).toBe(expectedOutput);
});
```

#### 3. モックの活用
```typescript
// 環境依存部分をモック化
jest.mock('fs', () => ({
  existsSync: jest.fn().mockReturnValue(true),
  readFileSync: jest.fn().mockReturnValue('mocked content')
}));
```

### 学び
1. **実装とテストのバランス**：テストが先行すべきだが、環境制約を考慮した柔軟なアプローチも必要
2. **TODOの明示**：解決できない問題は明確に記録し、後で対応する意図を残す
3. **テスト容易性の設計**：ファイルシステムや日付などの外部依存は分離し、モック可能な設計にする
4. **段階的なカバレッジ向上**：最初から100%のカバレッジを目指すのではなく、段階的に改善していく

## 今後の改善計画

### 短期的な計画（1-2週間）
1. 残りのテストカバレッジを向上させる（特にコアモジュール）
2. モック化の仕組みを整備（ファイルシステム、日付など）
3. CI環境でのテスト実行の安定化

### 中期的な計画（1ヶ月）
1. Node.jsのバージョンアップ（v18以上）
2. スキップしたテストの再有効化
3. テスト環境の分離と改善

### 長期的な計画
1. テストの並列実行とパフォーマンス改善
2. テスト容易性を考慮したリファクタリング
3. E2Eテストの導入 